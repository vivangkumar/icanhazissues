function pusherSync(){syncChannel.bind("client-issue-updates",function(e){var t=e.fromLabel,s=e.toLabel,a=e.toMilestone,o=e.fromMilestone,i=e.fromCount,n=e.toCount,r=e.issueLink,u=e.issueTitle,l=e.issueNumber;removeCard(t,l),appendCard(a,s,e.cardHtml),updateIssueCount(a,s,n),updateIssueCount(o,t,i);var d=parseInt($(".issue-list-group[data-milestone="+e.fromMilestone+"]").attr("data-limit")),c=parseInt($(".issue-list-group[data-milestone="+e.toMilestone+"]").attr("data-limit")),m=0,p=0;if($(".issue-list-group[data-label="+s+"]").each(function(){m+=parseInt($(this).attr("data-count"))}),$(".issue-list-group[data-label="+t+"]").each(function(){p+=parseInt($(this).attr("data-count"))}),d>=p&&transitionHeader(t,"white"),m>c&&transitionHeader(s,"red"),"done"==s){updateDoneBadge(a,n);var g=$(".issue-list-item[data-issue-number="+e.issueNumber+"]");hideOrShowDoneCard(g)}"done"==t&&updateDoneBadge(o,i),"review"==s&&triggerNotification(u,r,a)})}function setupSortableCards(){for(var e=document.getElementsByClassName("issue-list-group"),t="",s="",a="",o="",i=0;i<e.length;i++){var n=e[i].getAttribute("data-milestone");Sortable.create(e[i],{group:"issue-"+n,animation:150,dragable:".issue-list-item",ghostClass:"sortable-ghost",filter:".done-bucket",onStart:function(e){var s=e.item.parentNode;t=s.getAttribute("data-label"),a=s.getAttribute("data-milestone").replace(/ /g,"-")},onEnd:function(e){var i=e.item.getAttribute("data-issue-number"),n=e.item.getElementsByTagName("a")[0].innerHTML,r=e.item.getElementsByTagName("a")[0].href,u=e.item.parentNode,l=!1;s=u.getAttribute("data-label"),o=u.getAttribute("data-milestone").replace(/ /g,"-"),"true"==e.item.getAttribute("data-blocked")&&(l=!0);var d={issueNumber:i,issueTitle:n,fromMilestone:a,toMilestone:o,fromLabel:t,toLabel:s,issueLink:r};if(t!=s&&a==o){var c=parseInt(u.getAttribute("data-count")),m=parseInt(document.getElementsByClassName(a+"-"+t+"-list-group")[0].getAttribute("data-count"));c+=1,m-=1,u.setAttribute("data-count",c),updateIssueCount(a,t,m),"done"==s&&("false"==localStorage.doneColumn&&hideDoneCard(e.item),updateDoneBadge(o,c),switchToDoneLabel(e.item,t)),"done"==t&&(switchFromDoneLabel(e.item,s),updateDoneBadge(a,m));var p=0,g=0;$(".issue-list-group[data-label="+s+"]").each(function(){p+=parseInt($(this).attr("data-count"))}),$(".issue-list-group[data-label="+t+"]").each(function(){g+=parseInt($(this).attr("data-count"))});var f=parseInt(u.getAttribute("data-limit"));p>f&&transitionHeader(s,"red");var h=parseInt(document.getElementsByClassName(a+"-"+t+"-list-group")[0].getAttribute("data-limit"));h>=g&&transitionHeader(t,"white"),updateCardId(e.item,s,i),d.cardHtml=e.item.outerHTML,d.fromCount=m,d.toCount=c,syncChannel.trigger("client-issue-updates",d),updateIssue(i,t,s,l,n)}}})}}function removeCard(e,t){var s="#"+e+"-"+t;$(s).remove()}function appendCard(e,t,s){var a="."+e+"-"+t+"-list-group";$(a).append(s)}function updateIssueCount(e,t,s){$("."+e+"-"+t+"-list-group").attr("data-count",s)}function updateDoneBadge(e,t){$("."+e+"-done-badge").html(t)}function hideOrShowDoneCard(e){"false"==localStorage.doneColumn?e.css("display","none"):e.css("display","block")}function updateCardId(e,t,s){$(e).attr("id",t+"-"+s)}function hideDoneCard(e){$(e).css("display","none")}function switchToDoneLabel(e,t){$(e).addClass("issue-list-item-done"),$(e).removeClass("issue-list-item-"+t)}function switchFromDoneLabel(e,t){$(e).removeClass("issue-list-item-done"),$(e).addClass("issue-list-item-"+t)}function transitionHeader(e,t){$("."+e+"-heading").css("color",t)}function updateIssue(e,t,s,a,o){{var i="/issues/"+ownerName+"/"+repositoryName+"/update/"+e,n={issueTitle:o,oldLabel:t,newLabel:s,blocked:a};$.ajax({url:i,type:"POST",data:n,success:function(e){console.log(e)},error:function(e){console.log("Error: "+JSON.parse(e))}})}}function getColourCode(e){var e=new Date(e),t=new Date,s=t-e,a=864e5,o=t-t%a-a;return e>o?"#00B16A":7*a>s?"#F7CA18":14*a>s?"#F9690E":"#F22613"}function assignColourCode(){$(".issue-list-item").each(function(){var e=getColourCode($(this).attr("data-updated"));$(this).css("border-left-width","5px").css("border-left-color",e)})}function addBlockedLabel(){$('.issue-list-item[data-blocked="true"]').each(function(){var e='<span class="label label-danger">BLOCKED</span>';$(this).find(".issue-text").append("  "+e)})}function addMenu(){$(".heading-column:first-child").append('<a class="menu-button pull-left" data-toggle="dropdown" id="menu-dropdown"><i class="fa fa-bars fa-sm"></i></a><ul class="dropdown-menu" role="menu" aria-labelledby="menu-dropdown"><li role="presentation" class="dropdown-header">'+repositoryName+'</li><li role="presentation"><a role="menuitem" tabindex="-1" href="/repos">Repository search</a></li><li role="presentation"><a id="close-issues" role="menuitem" tabindex="-1" href="#">Close done issues</a></li><li role="presentation"><a class="toggle-done" role="menuitem" tabindex="-1" href="#">Toggle done items</a></li><li role="presentation"><a role="menuitem" tabindex="-1" href="/logout">Logout</a></li></ul>')}function closeIssues(){var e="/issues/"+ownerName+"/"+repositoryName+"/close",t=[];$(".issue-list-item-done").each(function(){t.push($(this).attr("data-issue-number"))});var s={issueNumbers:JSON.stringify(t)},a=function(e){$(".notifications").html(e).fadeOut(1e3),setTimeout(function(){location.reload()},1e3)};$("#close-issues").click(function(t){var o=confirm("This will close all issues in the done columns. Are you sure?");if(o){$.ajax({url:e,type:"POST",data:s,beforeSend:function(){$(".notifications").html("Deleting issues").show()},complete:function(e){a(200==e.status?"Issues closed..":"Error closing some issues..")}})}})}function addNewIssueButton(){var e="https://github.com/"+ownerName+"/"+repositoryName+"/issues/new";$(".heading-column:last-child").append('<a class="add-issue-button pull-right" target="_blank" href="'+e+'"><i class="fa fa-plus fa-sm"></i></a>')}function toggleDoneColumn(){$(".toggle-done").click(function(){localStorage.doneColumn="false"==localStorage.doneColumn?"true":"false",$(".issue-list-item-done").toggle(),$(".done-bucket").toggle(),"rgb(3, 166, 120)"==$(this).css("color")?$(this).css("color","white"):$(this).css("color","#03A678")})}function highlightHeadings(){var e=["ready","development","review","release","done"];e.forEach(function(e,t,s){var a=$("."+e+"-heading"),o=0;$(".issue-list-group[data-label="+e+"]").each(function(){o+=parseInt($(this).attr("data-count")),o>parseInt($(this).attr("data-limit"))&&a.css("color","red")})})}function retainPreviousSetting(){"false"==localStorage.doneColumn&&($(".done-bucket").css("display","block"),$(".issue-list-item-done").hide(),$(".toggle-done").css("color","#03A678"))}function setupNotification(){Notification||console.log("This browser does not support notifications"),"granted"!==Notification.permission&&Notification.requestPermission()}function triggerNotification(e,t,s){var a=new Notification(e+" is ready to be reviewed!",{tag:"icanhazissues-review-notification",body:"Card has been moved to the review column for the "+s+" milestone."});a.onclick=function(){window.open(t)},a.onshow=function(){setTimeout(a.close.bind(a),1e4)}}var repositoryName=window.location.pathname.split("/")[3],ownerName=window.location.pathname.split("/")[2],pusher=new Pusher(pusherKey,{authEndpoint:"/pusher/auth"}),syncChannelName="private-issues-"+repositoryName+"-"+ownerName,syncChannel=pusher.subscribe(syncChannelName),serverUpdatesChannelName=repositoryName+"-"+ownerName+"-server-updates",serverUpdatesChannel=pusher.subscribe(serverUpdatesChannelName);serverUpdatesChannel.bind("remove-done-cards",function(e){$(".notifications").html(e.status?"Deleted issue number "+e.issueNumber:"Failed to delete issue number "+e.issueNumber)}),$(window).load(function(){setupSortableCards(),pusherSync(),addMenu(),addNewIssueButton(),assignColourCode(),addBlockedLabel(),toggleDoneColumn(),retainPreviousSetting(),setupNotification(),closeIssues(),$(".notifications").hide(),highlightHeadings()});