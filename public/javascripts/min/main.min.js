function setupSortableCards(){for(var e=$(".issue-list-group"),s="",a="",t="",n="",o=0;o<e.length;o++){var i=$(e[o]).attr("data-milestone");Sortable.create(e[o],{group:"issue-"+i,animation:150,dragable:".issue-list-item",ghostClass:"sortable-ghost",filter:".done-bucket",onStart:function(e){var a=$(e.item).parent();s=a.attr("data-label"),t=a.attr("data-milestone").replace(/ /g,"-")},onEnd:function(e){var o=$(e.item).attr("data-issue-number"),i=$(e.item).find("a")[0].text,l=($(e.item).find("a")[0].href,$(e.item).parent()),r=!1;if(a=l.attr("data-label"),n=l.attr("data-milestone").replace(/ /g,"-"),"true"==$(e.item).attr("data-blocked")&&(r=!0),s!=a&&t==n){updateIssue(o,s,a,r,i);{var u=n;getCount(u,s),getCount(u,a)}a==DONE_LABEL&&hideOrShowDoneCard($(e.item))}}})}}function githubSync(){var e=repositoryName+"-"+ownerName+"-githubsync",s=pusher.subscribe(e);s.bind("labeled",function(e){var s=selectCard(e),a=e.label.name;a!=READY_LABEL||s.length||addNewCard(e,a),a==BLOCKED_LABEL&&addBlockedLabelToCard(e)}),s.bind("unlabeled",function(e){var s=selectCard(e);console.log(s);var a="";e.issue.labels.length>0&&(a=e.issue.labels[0].name);var t=e.label.name,n=getMilestoneName(e),o=getCount(n,t);if(console.log(t,a,n),a.length){var i=getCount(n,a);removeCard(t,e.issue.number),appendCard(n,a,s),updateIssueCount(n,a,i+1),updateIssueCount(n,t,o-1),switchLabels(s,t,a),updateCardId(s,a,e.issue.number),a==DONE_LABEL&&(updateDoneBadge(n,i+1),hideOrShowDoneCard(s)),t==DONE_LABEL&&(updateDoneBadge(n,o-1),s.css("display","block"))}else updateIssueCount(n,t,o-1),s.remove();t==BLOCKED_LABEL&&removeBlockedLabelFromCard(e)}),s.bind("assigned",function(e){assignIssue(e)}),s.bind("unassigned",function(e){unassignIssue(e)}),s.bind("closed",function(e){closeIssue(e)}),s.bind("reopened",function(e){var s=e.issue.labels[0].name;addNewCard(e,s)})}function assignIssue(e){var s=selectCard(e);s.find(".issue-text").removeClass("col-xs-12").addClass("col-xs-8");var a='<div class="issue-assignee col-xs-4 pull-right"><span class="pull-right"><img src="'+e.issue.assignee.avatar_url+'&s=35" class="img-circle avatar"></span></div>';s.find(".issue-assignee").length||s.append(a)}function unassignIssue(e){var s=selectCard(e);s.find(".issue-text").removeClass("col-xs-8").addClass("col-xs-12"),s.find(".issue-assignee").remove()}function closeIssue(e){var s=selectCard(e);s.remove();var a=getMilestoneName(e),t=selectMilestone(e),n=t.attr("data-count");t.attr("data-count",n-1),updateDoneBadge(a,n-1)}function addNewCard(e,s){var a=getMilestoneName(e),t=$("<li></li>");$(t).attr("data-updated",e.issue.updated_at),$(t).attr("data-issue-number",e.issue.number),$(t).attr("id",s+"-"+e.issue.number),$(t).addClass("list-group-item").addClass("issue-list-item").addClass("issue-list-item-"+s);var n=getCount(a,s);updateIssueCount(a,s,n+1),$(t).append('<div class="issue-text col-xs-12"><a href="'+e.issue.html_url+'" target="_blank">'+e.issue.title+"</a></div>"),$(t).find(".issue-assignee").remove(),appendCard(a,s,t),e.issue.assignee&&assignIssue(e),assignColourCode()}function selectCard(e){return $(".issue-list-item[data-issue-number="+e.issue.number+"]")}function selectMilestone(e){var s=e.issue.labels[0].name,a=e.issue.milestone||"uncategorized";return a.replace(/ /g,"-"),$("."+a+"-"+s+"-list-group")}function removeCard(e,s){var a="#"+e+"-"+s;$(a).remove()}function appendCard(e,s,a){var t="."+e+"-"+s+"-list-group";$(t).append(a)}function updateIssueCount(e,s,a){$("."+e+"-"+s+"-list-group").attr("data-count",a)}function updateDoneBadge(e,s){$("."+e+"-done-badge").html(s)}function hideOrShowDoneCard(e){"false"==localStorage.doneColumn?e.css("display","none"):e.css("display","block")}function updateCardId(e,s,a){$(e).attr("id",s+"-"+a)}function hideDoneCard(e){$(e).css("display","none")}function switchLabels(e,s,a){$(e).addClass("issue-list-item-"+a),$(e).removeClass("issue-list-item-"+s)}function getCount(e,s){return parseInt($("."+e+"-"+s+"-list-group").attr("data-count"))}function getMilestoneName(e){var s=e.issue.milestone;return s=s?e.issue.milestone.title:"uncategorized",s.replace(/ /g,"-"),s}function updateIssue(e,s,a,t,n){{var o="/issues/"+ownerName+"/"+repositoryName+"/update/"+e,i={issueTitle:n,oldLabel:s,newLabel:a,blocked:t};$.ajax({url:o,type:"POST",data:i,success:function(e){console.log(e)},error:function(e){console.log("Error: "+JSON.parse(e))}})}}function getColourCode(e){var e=new Date(e),s=new Date,a=s-e,t=864e5,n=s-s%t-t;return e>n?"#00B16A":7*t>a?"#F7CA18":14*t>a?"#F9690E":"#F22613"}function assignColourCode(){$(".issue-list-item").each(function(){var e=getColourCode($(this).attr("data-updated"));$(this).css("border-left-width","5px").css("border-left-color",e)})}function addBlockedLabels(){$('.issue-list-item[data-blocked="true"]').each(function(){var e='<span class="label blocked-label label-danger">BLOCKED</span>';$(this).find(".issue-text").append("  "+e)})}function addBlockedLabelToCard(e){var s=selectCard(e),a='<span class="label blocked-label label-danger">BLOCKED</span>';$(s).find(".issue-text").append(" "+a)}function removeBlockedLabelFromCard(e){var s=selectCard(e);$(s).find(".blocked-label").remove()}function addMenu(){$(".heading-column:first-child").append('<a class="menu-button pull-left" data-toggle="dropdown" id="menu-dropdown"><i class="fa fa-bars fa-sm"></i></a><ul class="dropdown-menu" role="menu" aria-labelledby="menu-dropdown"><li role="presentation" class="dropdown-header">'+repositoryName+'</li><li role="presentation"><a role="menuitem" tabindex="-1" href="/repos">Repository search</a></li><li role="presentation"><a id="close-issues" role="menuitem" tabindex="-1" href="#">Close done issues</a></li><li role="presentation"><a class="toggle-done" role="menuitem" tabindex="-1" href="#">Toggle done items</a></li><li role="presentation"><a role="menuitem" tabindex="-1" href="/logout">Logout</a></li></ul>')}function closeIssues(){var e="/issues/"+ownerName+"/"+repositoryName+"/close",s=[];$(".issue-list-item-done").each(function(){s.push($(this).attr("data-issue-number"))});var a={issueNumbers:JSON.stringify(s)},t=function(e){$(".notifications").html(e).fadeOut(1e3)};$("#close-issues").click(function(s){var n=confirm("This will close all issues in the done columns. Are you sure?");if(n){$.ajax({url:e,type:"POST",data:a,beforeSend:function(){$(".notifications").html("Deleting issues").show()},complete:function(e){t(200==e.status?"Issues closed..":"Error closing some issues..")}})}})}function addNewIssueButton(){var e="https://github.com/"+ownerName+"/"+repositoryName+"/issues/new";$(".heading-column:last-child").append('<a class="add-issue-button pull-right" target="_blank" href="'+e+'"><i class="fa fa-plus fa-sm"></i></a>')}function toggleDoneColumn(){$(".toggle-done").click(function(){localStorage.doneColumn="false"==localStorage.doneColumn?"true":"false",$(".issue-list-item-done").toggle(),$(".done-bucket").toggle(),"rgb(3, 166, 120)"==$(this).css("color")?$(this).css("color","white"):$(this).css("color","#03A678")})}function retainPreviousSetting(){"false"==localStorage.doneColumn&&($(".done-bucket").css("display","block"),$(".issue-list-item-done").hide(),$(".toggle-done").css("color","#03A678"))}var repositoryName=window.location.pathname.split("/")[3],ownerName=window.location.pathname.split("/")[2],pusher=new Pusher(pusherKey,{authEndpoint:"/pusher/auth"}),BLOCKED_LABEL="blocked",DONE_LABEL="done",READY_LABEL="ready";$(window).load(function(){setupSortableCards(),addMenu(),addNewIssueButton(),assignColourCode(),addBlockedLabels(),toggleDoneColumn(),retainPreviousSetting(),closeIssues(),$(".notifications").hide(),githubSync()});